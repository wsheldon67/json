<html>
<head>
<script src='data.js'></script>
<script src='items.js'></script>
<link rel="stylesheet" type="text/css" href="style.css">
<style>

</style>
</head>
<body onload='onload()'>
<div class='panel' style='width: 160px'>
    <input class='row' type="file" id='cFile'>
    <h2>Panels</h2>
    <div class='row'><button onclick='show("skills")'>Skills</button></div>
    <div class='row'><button onclick='show("otherRolls")'>Other Rolls</button></div>
    <div class='row'><button onclick='show("combat")'>Combat</button></div>
    <div class='row'><button onclick='show("inventory")'>Inventory</button></div>
    <div class='row'><button onclick='show("notes")'>Notes</button></div>
    <div class='row'><button onclick='show("info")'>Character Info</button></div>
    <h2>Dice Roller</h2>
    <div class='row'><input type='number' min='0' value='1' id='diceQ'>d<input type='number' min='0' value='20' id='diceD'></div>
    <button onclick='diceRoller()'>Roll</button>
    <div id='diceResult' style='text-align: center; font-size: 2em'></div>
    <h2>Save</h2>
    <div class='row'><button onclick='downloadC()'>Save Character</button><a id="download">Download</a></div>
</div>
<div class='panel' id='skills'>
    <h2>Skill Checks</h2>
    <table id='skillTable'>
        <tr><th>Skill</th><th>Mod</th><th>Roll</th><th>Result</th></tr>
    </table>
</div>
<div class='panel' id='otherRolls'>
    <h2>Ability Rolls</h2>
    <table id='abilityRolls'></table>
    <h2>Saving Throws</h2>
    <table>
        <tr><td>Fortitude</td><td><button onclick='saveRoll("fort")'>Roll</button></td><td id='fortSave'></td></tr>
        <tr><td>Reflex</td><td><button onclick='saveRoll("ref")'>Roll</button></td><td id='refSave'></td></tr>
        <tr><td>Will</td><td><button onclick='saveRoll("will")'>Roll</button></td><td id='willSave'></td></tr>
    </table>
</div>
<div class='section' id='combat'>
    <div class='panel'>
        <h2>Weapons</h2>
        <h3>Main Attack</h3>
        <select id='mainHandWeapon' oninput='updateWeapon("mainHand")'><option>None</option></select>
        <select id='mainHandAmmo' style='display: none;'><option>None</option></select>
        <div class='row'>Dmg: <div id='mainHandDmg'></div></div>
        <div class='row'>Crit: <div id='mainHandCrit'></div></div>
        <div class='row' style='display: none;'>Range: <div id='mainHandRange'></div></div>
        <h3>Off Hand</h3>
        <select id='offHandWeapon' oninput='updateWeapon("offHand")'><option>None</option></select>
        <select id='offHandAmmo' style='display: none;'><option>None</option></select>
        <div class='row'>Dmg: <div id='offHandDmg'></div></div>
        <div class='row'>Crit: <div id='offHandCrit'></div></div>
        <div class='row' style='display: none;'>Range: <div id='offHandRange'></div></div>
        <h3>Natural Attack</h3>
        <select id='natural1Weapon' oninput='updateWeapon("natural1")'><option>None</option></select>
        <div class='row'>Dmg: <div id='natural1Dmg'></div></div>
        <div class='row'>Crit: <div id='natural1Crit'></div></div>
        <div class='row' style='display: none;'>Range: <div id='natural1Range'></div></div>
        <h3>Natural Attack</h3>
        <select id='natural2Weapon' oninput='updateWeapon("natural2")'><option>None</option></select>
        <div class='row'>Dmg: <div id='natural2Dmg'></div></div>
        <div class='row'>Crit: <div id='natural2Crit'></div></div>
        <div class='row' style='display: none;'>Range: <div id='natural2Range'></div></div>
        <h3>Natural Attack</h3>
        <select id='natural3Weapon' oninput='updateWeapon("natural3")'><option>None</option></select>
        <div class='row'>Dmg: <div id='natural3Dmg'></div></div>
        <div class='row'>Crit: <div id='natural3Crit'></div></div>
        <div class='row' style='display: none;'>Range: <div id='natural3Range'></div></div>
    </div>
    <div class='panel'>
        <h2>Standard Attack</h2>
        <div id='mainHand'></div>
        <div class='row'>Attack: <button>Roll</button><div></div></div>
        <div class='row'>Damage: <button>Roll</button><div></div></div>
        <div class='row' title='Re-roll attack to confirm crit.' style='display: none;'>Crit! <button>Confirm</button></div>
        <h2>Full Round Attack</h2>
        <div class='panel' id='primary2' style='display: none;'>
            <h3>2nd Attack</h3>
            <div class='row'>Attack: <button>Roll</button><div></div></div>
            <div class='row'>Damage: <button>Roll</button><div></div></div>
            <div class='row' title='Re-roll attack to confirm crit.' style='display: none;'>Crit! <button>Confirm</button></div>
        </div>
        <div class='panel' id='primary3' style='display: none;'>
            <h3>3rd Attack</h3>
            <div class='row'>Attack: <button>Roll</button><div></div></div>
            <div class='row'>Damage: <button>Roll</button><div></div></div>
            <div class='row' title='Re-roll attack to confirm crit.' style='display: none;'>Crit! <button>Confirm</button></div>
        </div>
        <div class='panel' id='primary4' style='display: none;'>
            <h3>4th Attack</h3>
            <div class='row'>Attack: <button>Roll</button><div></div></div>
            <div class='row'>Damage: <button>Roll</button><div></div></div>
            <div class='row' title='Re-roll attack to confirm crit.' style='display: none;'>Crit! <button>Confirm</button></div>
        </div>
        <div class='panel' id='offHand' style='display: none;'>
            <h3>Secondary Attack</h3>
            <div class='row'>Attack: <button>Roll</button><div></div></div>
            <div class='row'>Damage: <button>Roll</button><div></div></div>
            <div class='row' title='Re-roll attack to confirm crit.' style='display: none;'>Crit! <button>Confirm</button></div>
        </div>
        <div class='panel' id='natural1' style='display: none;'>
            <h3>Natural Attack</h3>
            <div class='row'>Attack: <button>Roll</button><div></div></div>
            <div class='row'>Damage: <button>Roll</button><div></div></div>
            <div class='row' title='Re-roll attack to confirm crit.' style='display: none;'>Crit! <button>Confirm</button></div>
        </div>
        <div class='panel' id='natural2' style='display: none;'>
            <h3>Natural Attack</h3>
            <div class='row'>Attack: <button>Roll</button><div></div></div>
            <div class='row'>Damage: <button>Roll</button><div></div></div>
            <div class='row' title='Re-roll attack to confirm crit.' style='display: none;'>Crit! <button>Confirm</button></div>
        </div>
        <div class='panel' id='natural3' style='display: none;'>
            <h3>Natural Attack</h3>
            <div class='row'>Attack: <button>Roll</button><div></div></div>
            <div class='row'>Damage: <button>Roll</button><div></div></div>
            <div class='row' title='Re-roll attack to confirm crit.' style='display: none;'>Crit! <button>Confirm</button></div>
        </div>
    </div>
</div>
<div class='panel' id='inventory'>
    <h2>Store</h2>
    <div class='row'>Category: <select id='itemCat' oninput='updateItemSubCat()'></select></div>
    <div class='row'>Sub: <select id='itemSubCat' oninput='updateItems()'></select></div>
    <div class='row'><input type='number' value='1' min='1' id='itemQuantity'><input list='itemList' id='selectedItem' oninput='updateItem()'></div>
    <datalist id='itemList'></datalist>
    <div class='row'>Location: <input list='itemLocations' id='itemLocation' value='Inventory'></div>
    <datalist id='itemLocations'></datalist>
    <button onclick='addItem()'>Add</button>
    <div id='itemDisplay'></div>
    <div class='row'><input type='text' id='customAttribute'><button onclick="addItemAttribute()">Add Attribute</button></div>
    <div id='inventoryDisplay'></div>
</div>
<div class='panel' id='notes'>

</div>
<div class='panel' id='info'>
    <h2 id='name'></h2>
</div>
<script>
var itemObject = {};

// store uploaded character in variable c
const parsed = jsonText => JSON.parse(jsonText);
const fr = new FileReader();
function handleFileSelect (evt){
    fr.readAsText(evt.target.files[0])
}
fr.onload = e => {
    c = parsed(e.target.result);
    postC();
}
document.getElementById('cFile').addEventListener('change', handleFileSelect, false);

// download character
function downloadC(){
    var dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(c));
    var dElement = document.getElementById('download');
    dElement.setAttribute("href", dataStr);
    dElement.setAttribute("download", c.name+".json");
}

// load page
function onload(){
    // add item categories
    for (i in itemData){
        var o = document.createElement('option');
        o.innerHTML = i;
        document.getElementById('itemCat').appendChild(o);
    }
    updateItemSubCat();
}

// post character to page
function postC(){
    addSkills();
    addOtherRolls();
    addInfo();
    displayInventory();
    displayPrimaryAttacks();
}
function addSkills(){
    for (i in c.skills){
        var row = document.createElement('tr');
        var skill = document.createElement('td');
        skill.innerHTML = i;
        row.appendChild(skill);
        var mod = document.createElement('td');
        var modTotal = 0;
        for (k in c.skills[i]){
            modTotal += c.skills[i][k];
        }
        mod.innerHTML = modTotal;
        row.appendChild(mod);
        var roll = document.createElement('button');
        var rolltd = document.createElement('td');
        roll.innerHTML = 'Roll';
        roll.setAttribute('onclick','skillRoll("'+i+'")');
        rolltd.appendChild(roll);
        row.appendChild(rolltd);
        var result = document.createElement('td');
        result.id = i + 'Result';
        row.appendChild(result);
        document.getElementById('skillTable').appendChild(row);
    }
}
function addOtherRolls(){
    for (i in abilities){
        var row = document.createElement('tr');
        var label = document.createElement('td');
        label.innerHTML = i;
        label.title = 'Mod: '+c[i+'Mod'];
        row.appendChild(label);
        var buttontd = document.createElement('td');
        var button = document.createElement('button');
        button.innerHTML = 'Roll';
        button.setAttribute('onclick','abilityRoll("'+i+'")');
        buttontd.appendChild(button);
        row.appendChild(buttontd);
        var result = document.createElement('td');
        result.id = i+'Result';
        row.appendChild(result);
        document.getElementById('abilityRolls').appendChild(row);
    }
}
function addInfo(){
    document.getElementById('name').innerHTML = c.name;
}

// rolls
function skillRoll(skill){
    var modTotal = 0;
    for (k in c.skills[skill]){
        modTotal += c.skills[skill][k];
    }
    var roll = dice(1,20)
    document.getElementById(skill+'Result').innerHTML = roll + modTotal;
    document.getElementById(skill+'Result').title = 'd20: ' + roll;
}
function diceRoller(){
    var q = Number(document.getElementById('diceQ').value);
    var d = Number(document.getElementById('diceD').value);
    document.getElementById('diceResult').innerHTML = dice(q,d);
}
function abilityRoll(ability){
    var roll = dice(1,20);
    document.getElementById(ability+'Result').innerHTML = roll + c[ability+'Mod'];
    document.getElementById(ability+'Result').title = 'd20: ' + roll;
}
function saveRoll(save){
    var roll = dice(1,20);
    var saveMods = {'fort':c.conMod,'ref':c.dexMod,'will':c.wisMod}
    var totalMod = saveMods[save] + c[save+'Save'];
    document.getElementById(save+'Save').innerHTML = roll + totalMod;
    document.getElementById(save+'Save').title = 'd20: '+roll;
}

// Inventory
function updateItemSubCat(){
    var subCat = document.getElementById('itemSubCat');
    while (subCat.hasChildNodes()){
        subCat.removeChild(subCat.firstChild);
    }
    for (i in itemData[document.getElementById('itemCat').value]){
        var o = document.createElement('option');
        o.innerHTML = i;
        document.getElementById('itemSubCat').appendChild(o);
    }
    updateItems();
}
function updateItems(){
    var itemList = document.getElementById('itemList');
    while (itemList.hasChildNodes()){
        itemList.removeChild(itemList.firstChild);
    }
    var subCat = itemData[document.getElementById('itemCat').value][document.getElementById('itemSubCat').value];
    for (i in subCat){
        var o = document.createElement('option');
        o.innerHTML = i;
        document.getElementById('itemList').appendChild(o);
    }
}
function updateItem(){
    var cat = document.getElementById('itemCat').value;
    var subCat = document.getElementById('itemSubCat').value;
    var itemName = document.getElementById('selectedItem').value;
    var itemLocation = document.getElementById('itemLocation').value;
    var itemQuant = Number(document.getElementById('itemQuantity').value);
    itemObject = itemData[cat][subCat][itemName];
    document.getElementById('itemDisplay').innerHTML = '';
    for (i in itemObject){
        var row = document.createElement('div');
        row.innerHTML = i+": ";
        row.setAttribute('style','display: flex; justify-content: space-between');
        var value = document.createElement('textarea');
        value.rows = "1";
        value.value = itemObject[i];
        value.id = i+'Item'
        value.setAttribute('oninput','updateItemInfo()')
        row.appendChild(value);
        document.getElementById('itemDisplay').appendChild(row);
    }
}
function addItemAttribute(){
    var row = document.createElement('div');
    var key = document.getElementById('customAttribute').value;
    row.innerHTML = key + ": ";
    row.setAttribute('style','display: flex; justify-content: space-between');
    var value = document.createElement('textarea');
    value.rows = '1';
    value.id = key+'Item'
    value.setAttribute('oninput','updateItemInfo()');
    row.appendChild(value);
    document.getElementById('itemDisplay').appendChild(row);
    if (typeof(itemObject) == "undefined"){itemObject = {}};
    itemObject[key] = '';
}
function updateItemInfo(){
    for (i in itemObject){
        if (isNaN(Number(document.getElementById(i+'Item').value))){itemObject[i] = document.getElementById(i+'Item').value}
        else {itemObject[i] = Number(document.getElementById(i+'Item').value)};
    }
}
function addItem(){
    // add to c.items
    var cat = document.getElementById('itemCat').value;
    var subCat = document.getElementById('itemSubCat').value;
    var itemName = document.getElementById('selectedItem').value;
    var itemLocation = document.getElementById('itemLocation').value;
    var itemQuant = Number(document.getElementById('itemQuantity').value);
    if (typeof(c.items[itemLocation]) == "undefined"){c.items[itemLocation] = {}};
    if (typeof(c.items[itemLocation][cat]) == "undefined"){c.items[itemLocation][cat] = {}};
    itemObject.subCat = subCat;
    itemObject.name = itemName;
    itemObject.quantity = itemQuant;
    if (typeof(c.items[itemLocation][cat][itemName]) == "undefined"){
        c.items[itemLocation][cat][itemName] = itemObject;
    } else {
        c.items[itemLocation][cat][itemName].quantity += itemQuant;
    }
    document.getElementById('selectedItem').value = '';
    displayInventory();
}
function displayInventory(){
    document.getElementById('itemLocations').innerHTML = '';
    document.getElementById('inventoryDisplay').innerHTML = '';
    for (i in c.items){
        var o = document.createElement('option');
        o.innerHTML = i;
        document.getElementById('itemLocations').appendChild(o);
        var header = document.createElement('h2');
        header.innerHTML = i;
        //header.id = i + 'Header';
        document.getElementById('inventoryDisplay').appendChild(header);
        for (k in c.items[i]){
            var cat = document.createElement('h3');
            cat.innerHTML = k;
            document.getElementById('inventoryDisplay').appendChild(cat);
            for (j in c.items[i][k]){
                var item = document.createElement('div');
                var nitemObject = c.items[i][k][j];
                item.innerHTML = nitemObject.quantity +" - "+ nitemObject.name;
                item.title = nitemObject.description;
                document.getElementById('inventoryDisplay').appendChild(item);
            }
        }
    }
    updateAvailableWeapons();
}

// combat
function updateAvailableWeapons(){
    function reset(elem){
        document.getElementById(elem).innerHTML = '<option>None</option>'
    }
    reset('mainHandWeapon');
    reset('offHandWeapon');
    reset('natural1Weapon');
    reset('natural2Weapon');
    reset('natural3Weapon');
    var weapons = c.items.Inventory.Weapons;
    for (i in weapons){
        var o = document.createElement('option');
        o.innerHTML = i;
        document.getElementById('mainHandWeapon').appendChild(o.cloneNode(true));
        if (weapons[i].subCat != 'Two-Handed Melee'){document.getElementById('offHandWeapon').appendChild(o.cloneNode(true))};
        if (weapons[i].subCat == 'Natural' && !(weapons[i].hand)){
            document.getElementById('natural1Weapon').appendChild(o.cloneNode(true));
            document.getElementById('natural2Weapon').appendChild(o.cloneNode(true));
            document.getElementById('natural3Weapon').appendChild(o.cloneNode(true));
        }
    }
}
var currentWeapons = {};
function updateWeapon(body){
    var weapons = c.items.Inventory.Weapons;
    weapons.None = {'sDmg':'','mDmg':'','crit':'','mincrit':'','isNone':true}
    currentWeapons[body] = weapons[document.getElementById(body+'Weapon').value];
    if (body == 'mainHand'){updateMainWeapon()};
    var sizeDmg = {'Small':'sDmg','Medium':'mDmg'};
    document.getElementById(body+'Dmg').innerHTML = currentWeapons[body][sizeDmg[c.size]];
    document.getElementById(body+'Crit').innerHTML = currentWeapons[body].mincrit + " / x" + currentWeapons[body].crit;
    if (currentWeapons[body].subCat == "Ranged"){
        document.getElementById(body+'Range').innerHTML = currentWeapons[body].range;
        document.getElementById(body+'Range').parentNode.setAttribute('style','display: flex;');
    } else {
        document.getElementById(body+'Range').parentNode.setAttribute('style','display: none;');
    }
    if (!currentWeapons[body].isNone){
        document.getElementById(body).setAttribute('style','display: flex;');
    } else {
        document.getElementById(body).setAttribute('style','display: none;');
    }
}
function updateMainWeapon(){
    if (currentWeapons.mainHand.subCat == 'Two-Handed Melee'){
        document.getElementById('offHandWeapon').value = 'None';
        document.getElementById('offHandWeapon').setAttribute('disabled','disabled');
    } else {
        document.getElementById('offHandWeapon').removeAttribute('disabled');
    }
}
function displayPrimaryAttacks(){
    switch(Math.floor((c.bab-1)/5)){
        case 3: document.getElementById('primary4').setAttribute('style','display: flex;');
        case 2: document.getElementById('primary3').setAttribute('style','display: flex;');
        case 1: document.getElementById('primary2').setAttribute('style','display: flex;');
    }
}
</script>
</body>
</html>
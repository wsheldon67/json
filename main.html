<html>
<head>
<script src='data.js'></script>
<style>
*{
    font-family: sans-serif;
}
.panel {
    display: flex;
    flex-direction: column;
}
.row {
    display: flex;
    flex-direction: row;
    justify-content: space-between;
    margin-top: 5px;
    margin-bottom: 5px;
}
input[type="number"]{
    width: 60px
}
input[type="text"]{
    width: 140px;
}
h2{
    background-color: lightgreen;
    font-size: 1em;
    text-align: center;
    padding-top: 5px;
    padding-bottom: 5px;
    margin-top: 2px;
    margin-bottom: 2px;
}
h3{
    background-color: lavender;
    text-align: center;
    padding-top: 2px;
    padding-bottom: 2px;
    margin-top: 0px;
    margin-bottom: 1px;
    font-size: 1em;
}
body{
    display: flex;
    flex-direction: row;
    justify-content: space-between;
}
th,td{
    text-align: center;
}
</style>
</head>
<body>
<div class='panel' style='width: 160px'>
    <input class='row' type="file" id='cFile'>
    <h2>Panels</h2>
    <div class='row'><button onclick='show("skills")'>Skills</button></div>
    <div class='row'><button onclick='show("otherRolls")'>Other Rolls</button></div>
    <div class='row'><button onclick='show("combat")'>Combat</button></div>
    <div class='row'><button onclick='show("inventory")'>Inventory</button></div>
    <div class='row'><button onclick='show("notes")'>Notes</button></div>
    <div class='row'><button onclick='show("info")'>Character Info</button></div>
    <h2>Dice Roller</h2>
    <div class='row'><input type='number' min='0' value='1' id='diceQ'>d<input type='number' min='0' value='20' id='diceD'></div>
    <button onclick='diceRoller()'>Roll</button>
    <div id='diceResult' style='text-align: center; font-size: 2em'></div>
    <h2>Save</h2>
    <div class='row'><button onclick='downloadC()'>Save Character</button><a id="download">Download</a></div>
</div>
<div class='panel' id='skills'>
    <h2>Skill Checks</h2>
    <table id='skillTable'>
        <tr><th>Skill</th><th>Mod</th><th>Roll</th><th>Result</th></tr>
    </table>
</div>
<div class='panel' id='otherRolls'>
    <h2>Ability Rolls</h2>
    <table id='abilityRolls'></table>
    <h2>Saving Throws</h2>
    <table>
        <tr><td>Fortitude</td><td><button onclick='saveRoll("fort")'>Roll</button></td><td id='fortSave'></td></tr>
        <tr><td>Reflex</td><td><button onclick='saveRoll("ref")'>Roll</button></td><td id='refSave'></td></tr>
        <tr><td>Will</td><td><button onclick='saveRoll("will")'>Roll</button></td><td id='willSave'></td></tr>
    </table>
</div>
<div class='panel' id='combat'>

</div>
<div class='panel' id='inventory'>

</div>
<div class='panel' id='notes'>

</div>
<div class='panel' id='info'>
    <h2 id='name'></h2>
</div>
<script>

// handy functions
function dice(q,d){
    var result = 0;
    for (i=0; i<q; i++){
        result = result + Math.floor(Math.random() * d) + 1;
    };
    return result;
};

function diceText (t){
    var ar = t.split("d");
    var q = ar[0];
    var d = ar[1];
    var result = 0;
    for (i=0; i<q; i++){
        result = result + Math.floor(Math.random() * d) + 1;
    };
    return result;
};

function removeElement(elementID){
    var element = document.getElementById(elementID);
    element.parentNode.removeChild(element);
};

function randBetween(l,h){
    return Math.floor(Math.random()*(h+1)+l);
}

// store uploaded character in variable c
const parsed = jsonText => JSON.parse(jsonText);
const fr = new FileReader();
function handleFileSelect (evt){
    fr.readAsText(evt.target.files[0])
}
fr.onload = e => {
    c = parsed(e.target.result);
    postC();
}
document.getElementById('cFile').addEventListener('change', handleFileSelect, false);

// download character
function downloadC(){
    var dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(c));
    var dElement = document.getElementById('download');
    dElement.setAttribute("href", dataStr);
    dElement.setAttribute("download", c.name+".json");
}

// post character to page
function postC(){
    addSkills();
    addOtherRolls();
    addInfo();
}
function addSkills(){
    for (i in c.skills){
        var row = document.createElement('tr');
        var skill = document.createElement('td');
        skill.innerHTML = i;
        row.appendChild(skill);
        var mod = document.createElement('td');
        var modTotal = 0;
        for (k in c.skills[i]){
            modTotal += c.skills[i][k];
        }
        mod.innerHTML = modTotal;
        row.appendChild(mod);
        var roll = document.createElement('button');
        var rolltd = document.createElement('td');
        roll.innerHTML = 'Roll';
        roll.setAttribute('onclick','skillRoll("'+i+'")');
        rolltd.appendChild(roll);
        row.appendChild(rolltd);
        var result = document.createElement('td');
        result.id = i + 'Result';
        row.appendChild(result);
        document.getElementById('skillTable').appendChild(row);
    }
}
function addOtherRolls(){
    for (i in abilities){
        var row = document.createElement('tr');
        var label = document.createElement('td');
        label.innerHTML = i;
        label.title = 'Mod: '+c[i+'Mod'];
        row.appendChild(label);
        var buttontd = document.createElement('td');
        var button = document.createElement('button');
        button.innerHTML = 'Roll';
        button.setAttribute('onclick','abilityRoll("'+i+'")');
        buttontd.appendChild(button);
        row.appendChild(buttontd);
        var result = document.createElement('td');
        result.id = i+'Result';
        row.appendChild(result);
        document.getElementById('abilityRolls').appendChild(row);
    }
}
function addInfo(){
    document.getElementById('name').innerHTML = c.name;
}

// show/hide sections
function show(section){
    var s = document.getElementById(section);
    if (s.style.display == 'none'){
        s.setAttribute('style','display: flex');
    } else {
        s.setAttribute('style','display: none');
    }
}

// rolls
function skillRoll(skill){
    var modTotal = 0;
    for (k in c.skills[skill]){
        modTotal += c.skills[skill][k];
    }
    var roll = dice(1,20)
    document.getElementById(skill+'Result').innerHTML = roll + modTotal;
    document.getElementById(skill+'Result').title = 'd20: ' + roll;
}
function diceRoller(){
    var q = Number(document.getElementById('diceQ').value);
    var d = Number(document.getElementById('diceD').value);
    document.getElementById('diceResult').innerHTML = dice(q,d);
}
function abilityRoll(ability){
    var roll = dice(1,20);
    document.getElementById(ability+'Result').innerHTML = roll + c[ability+'Mod'];
    document.getElementById(ability+'Result').title = 'd20: ' + roll;
}
function saveRoll(save){
    var roll = dice(1,20);
    var saveMods = {'fort':c.conMod,'ref':c.dexMod,'will':c.wisMod}
    var totalMod = saveMods[save] + c[save+'Save'];
    document.getElementById(save+'Save').innerHTML = roll + totalMod;
    document.getElementById(save+'Save').title = 'd20: '+roll;
}
</script>
</body>
</html>
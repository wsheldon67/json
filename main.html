<html>
<head>
<style>
*{
    font-family: sans-serif;
}
.panel {
    display: flex;
    flex-direction: column;
}
.row {
    display: flex;
    flex-direction: row;
    justify-content: space-between;
    margin-top: 5px;
    margin-bottom: 5px;
}
input[type="number"]{
    width: 60px
}
input[type="text"]{
    width: 140px;
}
h2{
    background-color: lightgreen;
    font-size: 1em;
    text-align: center;
    padding-top: 5px;
    padding-bottom: 5px;
    margin-top: 2px;
    margin-bottom: 2px;
}
h3{
    background-color: lavender;
    text-align: center;
    padding-top: 2px;
    padding-bottom: 2px;
    margin-top: 0px;
    margin-bottom: 1px;
    font-size: 1em;
}
body{
    display: flex;
    flex-direction: row;
    justify-content: space-between;
}
th,td{
    text-align: center;
}
</style>
<script src='data.js'></script>
</head>
<body onload='onload()'>
<div class='panel' style='width: 200px'>
    <input class='row' type="file" id='cFile'>
    <h2>General</h2>
    <div class='row'>Name: <input type='text' id='name' oninput="store('name')"></div>
    <div class='row'>Class: <select id='class' oninput="store('class')"></select></div>
    <div class='row'>Race: <select id='race' oninput="store('race')"></select></div>
    <div class='row'>Sex: <select id='gender' oninput="store('sex')"><option>Male</option><option>Female</option></select></div>
    <div class='row'>Favored Class Bonus: <select id='fcb' oninput="updateType()"><option>+1 HP</option><option>+1 Skill</option></select></div>
    <h2>Physical</h2>
    <div class='row'>Size: <div id='size'></div></div>
    <div class='row'>Speed: <div id='speed'></div></div>
    <div class='row'>Hit Points: <div id='hp'></div></div>
    <div class='row'><div>Age: <button onclick='rollForAge()'>Roll</button></div><div id='age'></div></div>
    <div class='row'><div>Height: <button onclick='rollForHeight()'>Roll</button></div><div id='height'></div></div>
    <div class='row'><div>Weight: <button onclick='rollForWeight()'>Roll</button></div><div id='weight'></div></div>
    <h2>Other</h2>
    <div class='row'><div>Wealth: <button onclick='rollForWealth()'>Roll</button></div><div id='wealth'></div></div>
    <div class='row'>Languages: <div id='lang'></div></div>
    <div class='row'>Senses: <div id='sense'></div></div>
    <div class='row'>Defense: <div id='defense'></div></div>
    <div class='row'>Offense: <div id='offense'></div></div>
    <div class='row'>Skills: <div id='skillBonus'></div></div>
    <div class='row'>Special: <div id='special'></div></div>
    <div class='row'><button onclick='downloadC()'>Save Character</button><a id="download">Download</a></div>
</div>
<div class='panel'>
    <h2>Abilities: <span id='abilityPoints'></span> Points</h2>
    <h3 id='rbWrapper'>Race Bonus: <span id='raceBonus'></span></h3>
    <table id='abilityTable'>
        <tr><th>Ability</th><th>Points</th><th>Cost</th><th>Race</th><th>Score</th><th>Mod</th></tr>
    </table>
</div>
<div class='panel'>
    <h2>Skills: <span id='skillPoints'></span> Ranks</h2>
    <table id='skillTable'>
        <tr><th>Skill</th><th>Ranks</th><th>Class Bonus</th><th>Ability Mod</th><th>Total</th></tr>
    </table>
</div>
<div class='panel'>
    <h2>Feats: <span id='feats'></span></h2>
    <div class='row'><input list='featList' id='feat'><button onclick='addFeat()'>Add</button></div>
    <datalist id='featList'></datalist>
    
</div>
<script>
var c = {
    "class":"Barbarian",
    "race":"Dwarf",
    "sex":"Male",
    "level":1,
    "skills":{}
}
// store uploaded character in variable c
const parsed = jsonText => JSON.parse(jsonText);
const fr = new FileReader();
function handleFileSelect (evt){
    fr.readAsText(evt.target.files[0])
}
fr.onload = e => {
    c = parsed(e.target.result);
    postC();
}
document.getElementById('cFile').addEventListener('change', handleFileSelect, false);

// download character
function downloadC(){
    var dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(c));
    var dElement = document.getElementById('download');
    dElement.setAttribute("href", dataStr);
    dElement.setAttribute("download", c.name+".json");
}

// post character to page
function postC(){
    console.log('not done yet');
}

function updateType(){
    c.size = raceData[c.race].Size
    document.getElementById('size').innerHTML = c.size;
    c.speed = raceData[c.race].Speed
    document.getElementById('speed').innerHTML = c.speed;
    c.lang = raceData[c.race]["Starting Languages"].split(", ")
    document.getElementById('lang').innerHTML = raceData[c.race]["Starting Languages"];
    document.getElementById('sense').innerHTML = raceData[c.race]["Senses"];
    document.getElementById('defense').innerHTML = raceData[c.race]["Defensive Traits"].replace('Â','');
    document.getElementById('offense').innerHTML = raceData[c.race]["Offensive Traits"].replace('Â','');
    document.getElementById('skillBonus').innerHTML = raceData[c.race]["Skill Bonuses"].replace('Â','');
    document.getElementById('special').innerHTML = raceData[c.race]["Spell-Like (Sp) or Supernatural (Su) Abilities"].replace('Â','');
    c.hp = classData[c.class].HitDie;
    document.getElementById('hp').innerHTML = c.hp;
    var feats = 1;
    if (c.class == 'Fighter'){
        feats++;
    }
    if (c.race == 'Human'){
        feats++;
    }
    document.getElementById('feats').innerHTML = feats;
    for (i in abilities){
        document.getElementById(i+'Race').value = raceData[c.race][i];
        if (raceData[c.race].any > 0){
            document.getElementById(i+'Race').removeAttribute('disabled');
        } else {
            document.getElementById(i+'Race').setAttribute('disabled','disabled');
        }
    }
    if (raceData[c.race].any == 0){
        document.getElementById('rbWrapper').setAttribute('hidden','hidden');
    } else {
        document.getElementById('rbWrapper').removeAttribute('hidden');
    }
    updateAbilities();
}

function store(key){
    c[key] = document.getElementById(key).value;
    updateType();
}

// load data
function onload(){
    // select boxes
    var i;
    for (i in raceData){
        var o = document.createElement('option');
        o.innerHTML = i;
        document.getElementById('race').appendChild(o);
    }
    for (i in classData){
        var o = document.createElement('option');
        o.innerHTML = i;
        document.getElementById('class').appendChild(o);
    }
    // ability table
    document.getElementById('abilityPoints').innerHTML = startingAbilityPoints;
    for (i in abilities){
        var row = document.createElement('tr');
        var ability = document.createElement('td');
        ability.innerHTML = abilities[i].name;
        row.appendChild(ability);
        var points = document.createElement('td');
        var input = document.createElement('input');
        input.type = 'number';
        input.max = 18;
        input.min = 7;
        input.value = 10;
        input.id = i+"Points";
        input.setAttribute("oninput", "updateAbilities()");
        points.appendChild(input);
        row.appendChild(points);
        var cost = document.createElement('td');
        cost.id = i+"Cost"
        row.appendChild(cost);
        var racetd = document.createElement('td');
        var race = document.createElement('input');
        race.id = i+"Race";
        race.setAttribute('type','number');
        race.min = 0;
        race.setAttribute('oninput','updateAbilities()')
        row.appendChild(race);
        var score = document.createElement('td');
        score.id = i+"Score";
        row.appendChild(score);
        var mod = document.createElement('td');
        mod.id = i+"Mod";
        row.appendChild(mod);
        document.getElementById('abilityTable').appendChild(row);
    }
    // skill table
    for (i in skillData){
        addSkill(i);
    }
    updateType();
}

function addSkill(i){
    var row = document.createElement('tr');
    var skill = document.createElement('td');
    skill.innerHTML = i;
    skill.id = i+'Skill'
    row.appendChild(skill);
    var ranktd = document.createElement('td');
    var rank = document.createElement('input');
    rank.value = 0;
    rank.min = 0;
    rank.max = c.level;
    rank.setAttribute('type','number');
    rank.id = i+'Rank';
    rank.setAttribute('oninput','updateSkills()')
    ranktd.appendChild(rank);
    row.appendChild(ranktd);
    var classB = document.createElement('td');
    classB.id = i+'Class';
    classB.innerHTML = 0;
    row.appendChild(classB);
    var ab = document.createElement('td');
    ab.id = i+'Ability';
    row.appendChild(ab);
    var total = document.createElement('td');
    total.id = i+'Total'
    row.appendChild(total);
    document.getElementById('skillTable').appendChild(row);
}

function rollForAge(){
    var ageCat = classData[c.class].AgeCategory;
    var baseAge = raceData[c.race].BaseAge;
    var ageRoll = raceData[c.race][ageCat];
    var age = baseAge + diceText(ageRoll);
    document.getElementById('age').innerHTML = age;
    c.age = age;
}

function dice(q,d){
    var result = 0;
    for (i=0; i<q; i++){
    result = result + Math.floor(Math.random() * (d - 1) ) + 1;
    };
    return result;
};

function diceText (t){
    var ar = t.split("d");
    var q = ar[0];
    var d = ar[1];
    var result = 0;
    for (i=0; i<q; i++){
        result = result + Math.floor(Math.random() * (d - 1) ) + 1;
    };
    return result;
};

function rollForHeight(){
    var base;
    var modRoll;
    if (c.sex == "Male"){
        base = raceData[c.race].mHeight;
        modRoll = raceData[c.race].mHeightMod;
    } else {
        base = raceData[c.race].fHeight;
        modRoll = raceData[c.race].fHeightMod;
    }
    var height = base + diceText(modRoll);
    var pretty = Math.floor(height/12) + "' " + height%12 +'"';
    document.getElementById('height').innerHTML = pretty;
    c.height = height;
}

function rollForWeight(){
    var base;
    var modRoll;
    if (c.sex == "Male"){
        base = raceData[c.race].mWeight;
        modRoll = raceData[c.race].mWeightMod;
    } else {
        base = raceData[c.race].fWeight;
        modRoll = raceData[c.race].fWeightMod;
    }
    var weight = base + diceText(modRoll);
    var pretty = weight + " lbs."
    document.getElementById('weight').innerHTML = pretty;
    c.weight = weight;
}

function rollForWealth(){
    var toRoll = classData[c.class].StartingWealth;
    var wealth = dice(toRoll,6)*10;
    document.getElementById('wealth').innerHTML = wealth + " gp";
    c.wealth = wealth * 100;
}

function updateAbilities(){
    var totalCost = 0;
    var totalRace = 0;
    for (i in abilities){
        var cost = abilityCost[document.getElementById(i+'Points').value];
        document.getElementById(i+'Cost').innerHTML = cost;
        totalCost += cost;
        var race = Number(document.getElementById(i+'Race').value);
        totalRace += race;
        c[i+'Score'] = Number(document.getElementById(i+'Points').value) + race;
        document.getElementById(i+'Score').innerHTML = c[i+'Score'];
        c[i+'Mod'] = Math.floor((c[i+'Score']-10)/2);
        document.getElementById(i+'Mod').innerHTML = c[i+'Mod'];
    }
    document.getElementById('raceBonus').innerHTML = raceData[c.race].any - totalRace;
    document.getElementById('abilityPoints').innerHTML = startingAbilityPoints - totalCost;
    c.ranks = classData[c.class].RanksLevel + c.intMod;
    if (document.getElementById('fcb').value == "+1 HP"){c.hp++}else{c.ranks++};
    updateSkills();
    return;
}

function updateSkills(){
    var totalCost = 0;
    for (i in skillData){
        var classB = 0;
        c.skills[i] = Number(document.getElementById(i+'Rank').value);
        if (classData[c.class].skills[i] == 1){
            document.getElementById(i+'Skill').setAttribute('style','font-weight: bold; background-color: #ddedff');
            if(c.skills[i] > 0){
                classB = 3;
            } else {
                classB = 0;
            }
        } else {
            document.getElementById(i+'Skill').setAttribute('style','font-weight: normal; background-color: white;');
            classB = 0;
        }
        document.getElementById(i+'Class').innerHTML = classB;
        var ab = c[skillData[i].ability+'Mod'];
        document.getElementById(i+'Ability').innerHTML = ab;
        var total = ab + classB + c.skills[i];
        document.getElementById(i+'Total').innerHTML = total;
        totalCost += c.skills[i];
    }
    document.getElementById('skillPoints').innerHTML = c.ranks - totalCost;
    return;
}
</script>
</body>
</html>